<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DAUN PADI: Deteksi Anomali Ubinan Padi</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { background:#f8f9fa; }
.card { border-radius:12px; }
.alert { white-space: pre-line; }

/* LOGIN */
#loginOverlay{
  position:fixed;
  inset:0;
  background:#f8f9fa;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.logo-padi svg{width:90px;height:90px;}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginOverlay">
  <div class="card p-4 shadow text-center" style="width:380px">

    <div class="logo-padi mx-auto mb-2">
      <svg viewBox="0 0 100 100">
        <path d="M50 90 C45 65 35 50 20 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <path d="M50 90 C55 65 65 50 80 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <circle cx="20" cy="30" r="6" fill="#f9a825"/>
        <circle cx="26" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="32" cy="26" r="6" fill="#f9a825"/>
        <circle cx="80" cy="30" r="6" fill="#f9a825"/>
        <circle cx="74" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="68" cy="26" r="6" fill="#f9a825"/>
      </svg>
    </div>

    <h5 class="fw-bold mb-1">DAUN PADI</h5>
    <div class="text-muted mb-3">Deteksi Anomali Ubinan Padi</div>

    <input id="loginUser" class="form-control mb-2" placeholder="User">
    <input id="loginPass" type="password" class="form-control mb-2" placeholder="Password">

    <div id="loginError" class="text-danger small d-none mb-2">
      User atau password salah
    </div>

    <button class="btn btn-success w-100" onclick="doLogin()">Login</button>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="container-fluid p-4" id="dashboard" style="display:none">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold">üåæ DAUN PADI: Deteksi Anomali Ubinan Padi</h4>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</div>

<div class="card mb-3">
  <div class="card-body">
    <label class="fw-bold">Pilih Sheet</label>
    <select id="sheetSelect" class="form-select"></select>
  </div>
</div>

<!-- WARNING SHEET -->
<div id="sheetWarning" class="alert alert-danger d-none mb-3"></div>

<div id="noDataAlert" class="alert alert-info d-none mb-3">
  ‚ÑπÔ∏è <b>Tidak ditemukan Anomali</b>
</div>

<!-- FILTERS (GLOBAL) -->
<div class="card mb-3">
  <div class="card-body row g-3">
    <div class="col-md-3">
      <label>Filter Subround</label>
      <select id="filterSubround" class="form-select"><option value="ALL">Semua</option></select>
    </div>
    <div class="col-md-3">
      <label>Filter Kabupaten</label>
      <select id="filterKab" class="form-select"><option value="ALL">Semua</option></select>
    </div>
  </div>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabTabel">Tabel Data</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabGrafik">Grafik</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabPeta">Peta</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabJuknis">Juknis</a></li>
</ul>

<div class="tab-content">

<!-- Tambahkan div tab-content baru di dalam div.tab-content -->
<div class="tab-content">
  <!-- TAB TABEL (tidak berubah) -->
  <div class="tab-pane fade show active" id="tabTabel">
    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="dataTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- TAB GRAFIK (tidak berubah) -->
  <div class="tab-pane fade" id="tabGrafik">
    <canvas id="chartKab"></canvas>
  </div>

  <!-- TAB PETA (diperbaiki dengan debug log) -->
  <div class="tab-pane fade" id="tabPeta">
    <div class="card mb-3">
      <div class="card-body row g-3">
        <div class="col-md-3">
          <label>Filter Kabupaten</label>
          <select id="filterKabPeta" class="form-select"><option value="ALL">Semua</option></select>
        </div>
        <div class="col-md-3">
          <label>Filter Subround</label>
          <select id="filterSubroundPeta" class="form-select"><option value="ALL">Semua</option></select>
        </div>
        <div class="col-md-3">
          <label>Filter Subsegmen</label>
          <select id="filterSubsegmenPeta" class="form-select"><option value="ALL">Semua</option></select>
        </div>
        <div class="col-md-3">
          <label>Filter Bulan</label>
          <select id="filterBulanPeta" class="form-select"><option value="ALL">Semua</option></select>
        </div>
        <div class="col-md-3">
          <label>Tipe Peta</label>
          <select id="mapType" class="form-select">
            <option value="streets">Peta Jalan</option>
            <option value="satellite">Peta Satelit</option>
          </select>
        </div>
      </div>
    </div>
    <div id="map" style="height: 500px;"></div>
  </div>

  <!-- TAB JUKNIS (baru) -->
  <div class="tab-pane fade" id="tabJuknis">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Petunjuk Penggunaan (Juknis)</h5>
        <p class="card-text">
          <!-- Placeholder untuk konten Juknis. Ganti dengan konten aktual jika ada. -->
          Berikut adalah petunjuk penggunaan aplikasi DAUN PADI: Deteksi Anomali Ubinan Padi.<br>
          1. Login menggunakan kode user dan password yang sama.<br>
          2. Pilih sheet data yang ingin dilihat.<br>
          3. Gunakan filter untuk menyaring data berdasarkan Subround dan Kabupaten.<br>
          4. Pada tab Tabel, lihat data anomali dengan kolom merah menunjukkan anomali.<br>
          5. Pada tab Grafik, lihat visualisasi data.<br>
          6. Pada tab Peta, lihat peta Indonesia dengan filter Kabupaten dan Subround.<br>
          7. Pada tab Juknis, baca petunjuk ini.<br>
          <!-- Tambahkan lebih banyak konten jika diperlukan -->
        </p>
      </div>
    </div>
  </div>
</div>


<script>
/* ================= LOGIN ================= */
const users=[];
for(let i=3301;i<=3329;i++) users.push(String(i));
for(let i=3371;i<=3376;i++) users.push(String(i));

function doLogin(){
  if(users.includes(loginUser.value)&&loginUser.value===loginPass.value){
    sessionStorage.setItem("login","1");
    loginOverlay.style.display="none";
    dashboard.style.display="block";
  }else loginError.classList.remove("d-none");
}
function logout(){sessionStorage.clear();location.reload();}
if(sessionStorage.getItem("login")==="1"){
  loginOverlay.style.display="none";
  dashboard.style.display="block";
}

/* ================= API ================= */
const API_URL_MAIN="https://script.google.com/macros/s/AKfycbz5mA_cLvAEiCV2zile4fio9EkCa4nZy9aahc0wO4xAeJw5UqJGj1ctKC9ouVhBcHgkZQ/exec";
const API_URL_MAP = "https://script.google.com/macros/s/AKfycbw1yAeI0KFwBQIjJEa8Ft0V9CAghFfN1p5jO9oH_0wn0RLn4kaEQdMjChHdcox9-LAN/exec"; // Untuk data peta (Alokasi, Realisasi) - dari spreadsheet kedua
/* ================= WARNING TEXT ================= */
const warningText = {
  r108: "berisi '2. Ubinan Prakarsa/Daerah' atau '3. Ubinan Lainnya'",
  r111: "berisi '2. Padi Ladang'",
  r111_r702: "r111 '1. Padi Sawah'  tapi r702 '5. Bukan Sawah atau r111 '2. Padi Ladang' tapi r702 '1. Sawah Irigas",
  r205_r206: "r205<17 tahun, tapi r206 '5. Akademi/D1/D2/D3 atau r205<20 tahun tapi r206 '6. Perguruan Tinggi/D4/S1/S2/S3 ",
  r601_bulanmaster: " selisih pelaksanaan ubinan dan perkiraan bulan panen lebih dari 1 bulan",
  r602: "r602<70 hari atau r602>130 hari",
  r604a: "r604a>=0.2kg",
  r604c: "- r604c<1 kg atau r604c>7.5kg",
  r701b: "r701b berisi 'Lainnya' namun sebenarnya masih bisa dimasukkan ke pilihan yang tersedia",
  r701c: "r701c berisi '5. Beras Lainnya'",
  r706: "berisi kurang dari 100 m2",
  r707b: "penggunaan benih per hektar di luar rentang 10-86 kg/ha",
  r708b: "penggunaan pupuk per hektar di luar rentang 150-1.000 kg/ha",
  r709: "r709a berisi '2. Tidak atau r709c berisi '4. Lainnya",
  r710: "r710b berisi lebih dari 3 kali",
  r801b: "r801b berisi '5. Lainnya'",
  r802b: "r802b berisi '5. Lainnya'",
  r803c: "r803c berisi 'Lainnya' namun sebenarnya masih bisa dimasukkan ke pilihan yang tersedia",
  r804c: "jika besarnya dampak lebih dari 50 persen",
  r805b: "r805b berisi '4. Lainnya' namun sebenarnya masih bisa dimasukkan ke pilihan yang tersedia",
  r805c: "jika besarnya dampak lebih dari 50 persen",
  r901: "r901 berisi '2. Ubinan Dinas atau r901 berisi '3. Ubinan Bersama"
};

/* ================= SHEET KHUSUS ================= */
const fullSheet=["Progress","Penjelasan Anomali","Rekap Anomali","Subsegmen Anomali"];

/* ================= RED COLUMNS ================= */
const redColumns = [
  "r108",
  "r111",
  "r111_r702",
  "r205_r206",
  "r601_bulanmaster",
  "r602",
  "r604a",
  "r604c",
  "r605",
  "r701b",
  "r701c",
  "r703",
  "r706",
  "r707b",
  "r708b",
  "r709",
  "r710b",
  "r801b",
  "r802b",
  "r803c",
  "r804c",
  "r805b",
  "r805c",
  "r901"
];

let rawData=[],header=[],chart;

/* ================= LOAD SHEET ================= */
fetch(API_URL_MAIN+"?action=sheets")
.then(r=>r.json())
.then(list=>{
  sheetSelect.innerHTML=list.filter(s=>s.toLowerCase()!=="raw data")
    .map(s=>`<option>${s}</option>`).join("");
  loadData();
});
sheetSelect.onchange=loadData;

/* ================= WARNING HANDLER ================= */
function updateWarning(){
  const key = sheetSelect.value.toLowerCase(); // Ubah key menjadi lowercase untuk match dengan warningText
  if(warningText[key]){
    sheetWarning.textContent = warningText[key];
    sheetWarning.classList.remove("d-none");
  }else{
    sheetWarning.classList.add("d-none");
  }
}

/* ================= LOAD DATA ================= */
function loadData(){
  updateWarning();

  fetch(API_URL_MAIN+"?action=data&sheet="+sheetSelect.value)
  .then(r=>r.json())
  .then(res=>{
    header=[...res.header];
    rawData=[...res.data];

    if(sheetSelect.value === "Subsegmen Anomali"){
      const totalIdx = header.indexOf("TOTAL");
      if(totalIdx !== -1){
        rawData = rawData.filter(r => Number(r[totalIdx]) > 0);
      }
    } else if(!fullSheet.includes(sheetSelect.value)){
      rawData=rawData.filter(r=>r[header.indexOf("flag_2")]==1);
    }

    if(rawData.length===0){
      noDataAlert.classList.remove("d-none");
      dataTable.tHead.innerHTML="";
      dataTable.tBodies[0].innerHTML="";
      if(chart) chart.destroy();
      return;
    }else noDataAlert.classList.add("d-none");

    buildFilters();
    renderTable();
    buildChart();
  });
}

/* ================= FILTER ================= */
function buildFilters(){
  fill(filterSubround, 6); // Kolom ke 7 (indeks 6)
  fill(filterKab, 1); // Kolom ke 2 (indeks 1)
}
function fill(sel,idx){
  const u=[...new Set(rawData.map(r=>r[idx]).filter(Boolean))];
  sel.innerHTML='<option value="ALL">Semua</option>'+u.map(v=>`<option>${v}</option>`).join('');
}
filterSubround.onchange=()=>{renderTable(); buildChart();};
filterKab.onchange=()=>{renderTable(); buildChart();};

/* ================= GET FILTERED DATA ================= */
function getFilteredData(){
  let data=[...rawData];
  if(filterSubround.value!="ALL") data=data.filter(r=>r[6]==filterSubround.value); // Indeks 6 untuk subround
  if(filterKab.value!="ALL") data=data.filter(r=>r[1]==filterKab.value); // Indeks 1 untuk kabupaten
  return data;
}


/* ================= LOCAL STORAGE FOR CHECKBOX ================= */
function getCheckboxKey(sheet, subround, kab, index){
  return `checkbox-${sheet}-${subround}-${kab}-${index}`;
}
function saveCheckbox(sheet, subround, kab, index, type, checked){
  const key = getCheckboxKey(sheet, subround, kab, index) + `-${type}`;
  localStorage.setItem(key, checked ? "1" : "0");
}
function loadCheckbox(sheet, subround, kab, index, type){
  const key = getCheckboxKey(sheet, subround, kab, index) + `-${type}`;
  return localStorage.getItem(key) === "1";
}

/* ================= TABLE ================= */
function renderTable(){
  let data=getFilteredData();
  let head=[...header];
  let rows=data.map(r=>[...r]);

  if(!fullSheet.includes(sheetSelect.value)){
    const idx=header.indexOf("flag_2");
    head.splice(idx+1,0,"Sesuai Lapangan","Butuh Perbaikan");
    rows=rows.map((r, i)=>{
      const subround = r[6]; // Indeks 6 untuk subround
      const kab = r[1]; // Indeks 1 untuk kabupaten
      const checked1 = loadCheckbox(sheetSelect.value, subround, kab, i, "sesuai") ? "checked" : "";
      const checked2 = loadCheckbox(sheetSelect.value, subround, kab, i, "perbaikan") ? "checked" : "";
      r.splice(idx+1,0,
        `<input type="checkbox" ${checked1} onchange="handleCheckbox(this, '${sheetSelect.value}', '${subround}', '${kab}', ${i}, 'sesuai')">`,
        `<input type="checkbox" ${checked2} onchange="handleCheckbox(this, '${sheetSelect.value}', '${subround}', '${kab}', ${i}, 'perbaikan')">`
      );
      return r;
    });
  }

  dataTable.tHead.innerHTML="<tr>"+head.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  dataTable.tBodies[0].innerHTML=rows.map(r=>"<tr>"+r.map((c, j)=>{
    let className = "";
    if (sheetSelect.value !== "Rekap Anomali" && redColumns.includes(head[j]) && Number(c) === 1) {
      className = "bg-danger text-white";
    }
    return `<td class="${className}">${c??""}</td>`;
  }).join("")+"</tr>").join("");
}

/* ================= HANDLE CHECKBOX ================= */
function handleCheckbox(cb, sheet, subround, kab, index, type){
  saveCheckbox(sheet, subround, kab, index, type, cb.checked);
}

/* ================= CHART ================= */
function buildChart(){
  if(chart) chart.destroy();
  if(sheetSelect.value === "Progress"){
    const data = getFilteredData();
    const kabIdx = 1; // Kolom ke 2 (indeks 1) untuk kabupaten
    const targetIdx = 3; // Kolom D
    const realisasiIdx = 4; // Kolom E
    if(data.length === 0){
      console.log("Data kosong untuk Progress.");
      return;
    }
    const grouped = {};
    data.forEach(r => {
      const kab = r[kabIdx];
      if(kab !== "00"){ // Skip kabupaten 00
        if(!grouped[kab]) grouped[kab] = {target: 0, realisasi: 0};
        grouped[kab].target += Number(r[targetIdx]) || 0;
        grouped[kab].realisasi += Number(r[realisasiIdx]) || 0;
      }
    });
    const labels = Object.keys(grouped).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Target",
            data: labels.map(l => grouped[l].target),
            backgroundColor: "#90EE90" // Hijau muda
          },
          {
            label: "Realisasi",
            data: labels.map(l => grouped[l].realisasi),
            backgroundColor: "#228B22" // Hijau tua
          }
        ]
      },
      options: {
        scales: {
          x: { stacked: false },
          y: { stacked: false }
        }
      }
    });
  } else if(sheetSelect.value === "Subsegmen Anomali"){
    const data = getFilteredData();
    const kabIdx = 1; // Kolom ke 2 (indeks 1) untuk kabupaten
    const totalIdx = header.indexOf("TOTAL");
    if(totalIdx === -1 || data.length === 0){
      console.log("Kolom TOTAL tidak ditemukan atau data kosong untuk Subsegmen Anomali.");
      return;
    }
    const grouped = {};
    data.forEach(r => {
      const kab = r[kabIdx];
      if(!grouped[kab]) grouped[kab] = 0;
      grouped[kab] += Number(r[totalIdx]) || 0;
    });
    const labels = Object.keys(grouped).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "TOTAL",
          data: labels.map(l => grouped[l]),
          backgroundColor: "#FFD700" // Warna kuning untuk TOTAL
        }]
      },
      options: {
        scales: {
          x: { stacked: false },
          y: { stacked: false }
        }
      }
    });
  } else if(!fullSheet.includes(sheetSelect.value)){
    const data = getFilteredData();
    const c = {};
    data.forEach(r => c[r[1]] = (c[r[1]] || 0) + 1); // Indeks 1 untuk kabupaten
    const labels = Object.keys(c).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: { labels, datasets: [{ label: "Jumlah Flag_2 = 1", data: labels.map(l => c[l]) }] }
    });
  }
}
/* ================= PETA ================= */
let map;
let markers = [];
let dataAlokasi = [];
let dataRealisasi = [];
let headerAlokasi = [];
let headerRealisasi = [];

// Fungsi helper untuk mencari indeks kolom (case-insensitive)
function colIndex(header, name) {
  return header.findIndex(h => h.toLowerCase() === name.toLowerCase());
}

function initMap() {
  if (map) map.remove();
  map = L.map('map').setView([-2.5, 118], 5); // Pusat Indonesia

  // Layer untuk peta jalan dan satelit
  const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  });

  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  // Default ke streets
  streets.addTo(map);

  // Event listener untuk mapType
  mapType.onchange = function() {
    map.eachLayer(function(layer) {
      if (layer instanceof L.TileLayer) {
        map.removeLayer(layer);
      }
    });
    if (this.value === 'satellite') {
      satellite.addTo(map);
    } else {
      streets.addTo(map);
    }
  };

  // Muat data dari sheet Alokasi dan Realisasi menggunakan API_URL_MAP
  Promise.all([
    fetch(API_URL_MAP + "?action=data&sheet=Alokasi").then(r => r.json()),
    fetch(API_URL_MAP + "?action=data&sheet=Realisasi").then(r => r.json())
  ]).then(([resAlokasi, resRealisasi]) => {
    headerAlokasi = [...resAlokasi.header];
    dataAlokasi = [...resAlokasi.data];
    headerRealisasi = [...resRealisasi.header];
    dataRealisasi = [...resRealisasi.data];

    // Debug: Log header untuk verifikasi
    console.log("headerAlokasi:", headerAlokasi);
    console.log("headerRealisasi:", headerRealisasi); // Tambahan: Lihat nama kolom yang sebenarnya

    // Build filters untuk peta (gunakan data gabungan untuk fill options, asumsikan header serupa)
    const allData = [...dataAlokasi, ...dataRealisasi];
    const allHeader = headerAlokasi.length > 0 ? headerAlokasi : headerRealisasi; // Fallback ke headerAlokasi
    // Hitung indeks secara dinamis (case-insensitive)
    const kabIdx = colIndex(allHeader, "kabupaten") !== -1 ? colIndex(allHeader, "kabupaten") : 1;
    const subroundIdx = colIndex(allHeader, "subround") !== -1 ? colIndex(allHeader, "subround") : 6;
    const subsegmenIdx = colIndex(allHeader, "subsegmen") !== -1 ? colIndex(allHeader, "subsegmen") : 7;
    const bulanIdx = colIndex(allHeader, "bulan") !== -1 ? colIndex(allHeader, "bulan") : 8;

    // Debug indeks
    console.log("kabIdx:", kabIdx, "subroundIdx:", subroundIdx, "subsegmenIdx:", subsegmenIdx, "bulanIdx:", bulanIdx);

    fill(filterKabPeta, kabIdx);
    fill(filterSubroundPeta, subroundIdx);
    fill(filterSubsegmenPeta, subsegmenIdx);
    fill(filterBulanPeta, bulanIdx);

    // Event listeners untuk filter
    filterKabPeta.onchange = updateMap;
    filterSubroundPeta.onchange = updateMap;
    filterSubsegmenPeta.onchange = updateMap;
    filterBulanPeta.onchange = updateMap;

    updateMap();
  }).catch(err => console.error("Error loading map data:", err));
}

function colLetterToIndex(letter) {
  let col = 0;
  for (let i = 0; i < letter.length; i++) {
    col = col * 26 + (letter.charCodeAt(i) - 64);
  }
  return col - 1; // zero-based index
}



function updateMap() {

  markers.forEach(marker => map.removeLayer(marker));
  markers = [];

  let allData = [
    ...dataAlokasi.map(row => ({ ...row, sheet: "Alokasi" })),
    ...dataRealisasi.map(row => ({ ...row, sheet: "Realisasi" }))
  ];

  // INDEX HEADER
  const kabIdxAlokasi = colIndex(headerAlokasi, "kabupaten");
  const subroundIdxAlokasi = colIndex(headerAlokasi, "subround");
  const subsegmenIdxAlokasi = colIndex(headerAlokasi, "subsegmen");
  const bulanIdxAlokasi = colIndex(headerAlokasi, "bulan");

  const kabIdxRealisasi = colIndex(headerRealisasi, "kabupaten");
  const subroundIdxRealisasi = colIndex(headerRealisasi, "subround");
  const subsegmenIdxRealisasi = colIndex(headerRealisasi, "subsegmen");
  const bulanIdxRealisasi = colIndex(headerRealisasi, "bulan");

  // KOLOM REALISASI STATUS
  let fkIdx = colIndex(headerRealisasi, "realisasi");

  // FILTER
  if (filterKabPeta.value !== "ALL")
    allData = allData.filter(r => r[(r.sheet==="Alokasi"?kabIdxAlokasi:kabIdxRealisasi)] == filterKabPeta.value);

  if (filterSubroundPeta.value !== "ALL")
    allData = allData.filter(r => r[(r.sheet==="Alokasi"?subroundIdxAlokasi:subroundIdxRealisasi)] == filterSubroundPeta.value);

  if (filterSubsegmenPeta.value !== "ALL")
    allData = allData.filter(r => r[(r.sheet==="Alokasi"?subsegmenIdxAlokasi:subsegmenIdxRealisasi)] == filterSubsegmenPeta.value);

  if (filterBulanPeta.value !== "ALL")
    allData = allData.filter(r => r[(r.sheet==="Alokasi"?bulanIdxAlokasi:bulanIdxRealisasi)] == filterBulanPeta.value);


  // LOOP DATA
  allData.forEach((row, i) => {

    let lat, lng;
    let markerColor = "blue";
    let popupData = [];

    // ================= ALOKASI =================
    if (row.sheet === "Alokasi") {
      const xIdx = colIndex(headerAlokasi, "x");
      const yIdx = colIndex(headerAlokasi, "y");

      lng = parseFloat(row[xIdx]);
      lat = parseFloat(row[yIdx]);
      markerColor = "blue";

      // kolom H, I, J, M, AA
      let idxH  = colLetterToIndex("H");
      let idxI  = colLetterToIndex("I");
      let idxJ  = colLetterToIndex("J");
      let idxM  = colLetterToIndex("M");
      let idxAA = colLetterToIndex("AA");

      popupData = [
        row[idxH],
        row[idxI],
        row[idxJ],
        row[idxM],
        row[idxAA]
      ];
    }


    // ================= REALISASI =================
    if (row.sheet === "Realisasi") {
      let aqIdx = colIndex(headerRealisasi, "AQ");
      let arIdx = colIndex(headerRealisasi, "AR");
      if (aqIdx === -1) aqIdx = 42;
      if (arIdx === -1) arIdx = 43;

      lng = parseFloat(row[aqIdx]);
      lat = parseFloat(row[arIdx]);

      let fk = fkIdx !== -1 ? String(row[fkIdx]).trim().toLowerCase() : "";

      if (fk === "alokasi") markerColor = "yellow";
      else if (fk === "tambahan") markerColor = "red";
      else markerColor = "gray";

      // kolom FF, FG, FH, FJ
      let idxFF = colLetterToIndex("FF");
      let idxFG = colLetterToIndex("FG");
      let idxFH = colLetterToIndex("FH");
      let idxFJ = colLetterToIndex("FJ");

      popupData = [
        row[idxFF],
        row[idxFG],
        row[idxFH],
        row[idxFJ]
      ];
    }


    // ================= DRAW MARKER =================
    if (!isNaN(lat) && !isNaN(lng)) {

      const m = L.circleMarker([lat, lng], {
        color: markerColor,
        fillColor: markerColor,
        fillOpacity: 0.85,
        radius: 5
      }).addTo(map);

      // popup tanpa nama kolom
      let popupHTML = popupData
        .filter(v => v !== undefined && v !== "")
        .join("<br>");

      m.bindPopup(popupHTML);

      markers.push(m);
    }
  });

  console.log("Total markers:", markers.length);
}


// ... (kode setelahnya tetap sama)

// Panggil initMap saat tab peta aktif
document.querySelector('a[href="#tabPeta"]').addEventListener('shown.bs.tab', initMap);

// Pastikan map diinisialisasi saat load data pertama kali jika tab aktif
if (sessionStorage.getItem("login") === "1") {
  setTimeout(() => {
    if (document.querySelector('a[href="#tabPeta"]').classList.contains('active')) {
      initMap();
    }
  }, 100);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
